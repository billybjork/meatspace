<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Clips</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <style>
        .clip-review-item {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .clip-review-item.processing, .clip-review-item.done {
            opacity: 0.5;
            pointer-events: none; /* Disable interactions when processing/done */
        }
        .clip-info { margin-bottom: 10px; font-size: 0.9em; color: #555; }
        .clip-actions button { margin: 5px; padding: 8px 12px; cursor: pointer; }
        .action-feedback { font-style: italic; margin-top: 5px; font-size: 0.9em;}
        .action-feedback.error { color: red; }
        .action-feedback.success { color: green; }
        .undo-button { background-color: #ffc107; color: black; }

        /* --- Sprite Viewer Styles --- */
        .sprite-viewer {
        background-size: cover; /* Keep default, JS overrides */
        background-repeat: no-repeat;
        border: 1px solid #aaa;
        margin-bottom: 5px;
        position: relative;
        overflow: hidden; /* Clips the background image */
        background-color: #222;
        color: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-style: italic;
        /* Add maybe a min-height just in case? */
        /* min-height: 50px; */
        }
        .sprite-viewer:focus { /* Style when focused for keyboard input */
            outline: 2px solid dodgerblue;
            box-shadow: 0 0 5px dodgerblue;
        }
        .sprite-viewer.no-sprite {
            background-image: none !important;
            /* Maybe give it a default size when no sprite? */
            min-height: 100px;
            width: 160px;
        }
        .playback-controls {
             display: flex;
             align-items: center;
             gap: 10px; /* Spacing between controls */
             margin-bottom: 10px;
        }
        .playback-controls input[type=range] {
            flex-grow: 1; /* Allow range slider to take up space */
            cursor: pointer;
        }
        .sprite-current-frame {
             font-family: monospace;
             font-size: 0.9em;
             min-width: 80px; /* Prevent layout shift */
             text-align: right;
        }

        /* --- Split Controls Styles --- */
        .split-controls {
             display: none; /* Hidden by default */
             margin-top: 10px;
             border: 1px dashed blue;
             padding: 10px;
             background-color: #eef;
        }
        .split-controls .frame-info {
            font-family: monospace;
            margin: 5px 0;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #ccc;
            display: inline-block; /* Fit content */
        }
        .split-feedback {
            margin-left: 10px;
            font-style: italic;
            color: #d00; /* Default to error color */
            font-size: 0.9em;
        }
        .split-feedback:empty {
             display: none; /* Hide if no feedback */
        }
        /* Style for disabled buttons */
        button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .split-mode-btn[disabled] { /* Specific styling for disabled split button */
            background-color: #eee;
            color: #999;
            border-color: #ddd;
        }
        .retry-sprite-btn { /* Button to retry sprite gen */
            background-color: #ffae42; /* Orange */
            color: black;
        }
    </style>
</head>
<body>
    <h1>Review Clips</h1>

    {% if error %}
        <p style="color: red;">Error: {{ error }}</p>
    {% endif %}

    <div id="review-queue">
        {% if clips %}
            {% for clip in clips %}
            {# --- Main Clip Item Div --- #}
            <div class="clip-review-item"
                 id="clip-{{ clip.clip_db_id }}"
                 data-clip-id="{{ clip.clip_db_id }}"
                 {# Pass necessary data for JS sprite handling #}
                 {% if clip.sprite_metadata and not clip.sprite_error %}
                 data-sprite-url="{{ clip.sprite_sheet_url }}"
                 data-sprite-meta="{{ clip.sprite_metadata|tojson|forceescape }}" {# Pass JSON metadata safely #}
                 {% endif %}
                 {# Pass FPS even if sprite failed, might be useful? #}
                 data-clip-fps="{{ clip.sprite_metadata.clip_fps if clip.sprite_metadata else '0' }}"
                 >

                {# --- Clip Info Header --- #}
                <div class="clip-info">
                    <strong>{{ clip.title }}</strong> ({{ clip.source_title }})<br>
                    ID: {{ clip.clip_db_id }} | Source ID: {{ clip.source_video_id }} | Time: {{ "%.3f"|format(clip.start_time) }}s - {{ "%.3f"|format(clip.end_time) }}s
                     {% if clip.sprite_error %} | <strong style="color:orange;">Sprite Failed</strong> {% endif %}
                </div>

                {# --- Sprite Viewer --- #}
                <div class="sprite-viewer" id="sprite-viewer-{{ clip.clip_db_id }}" tabindex="0"> {# tabindex makes it focusable #}
                     {# JS will populate background or show message #}
                     Loading sprite...
                 </div>

                {# --- Playback Controls --- #}
                <div class="playback-controls" id="controls-{{ clip.clip_db_id }}">
                     <button class="sprite-play-pause-btn" data-clip-id="{{ clip.clip_db_id }}" title="Play/Pause (Spacebar when focused)">‚èØÔ∏è</button>
                     <input type="range" class="sprite-scrub-bar" id="scrub-{{ clip.clip_db_id }}" value="0" min="0" max="100" title="Scrub through frames">
                     <span class="sprite-current-frame" id="frame-display-{{ clip.clip_db_id }}">Frame: 0</span>
                </div>

                {# --- Action Buttons --- #}
                <div class="clip-actions">
                    <button class="action-btn approve-btn" data-action="approve" title="Approve for embedding">‚úÖ Approve</button>
                    <button class="action-btn skip-btn" data-action="skip" title="Skip review for now">‚è≠Ô∏è Skip</button>
                    <button class="action-btn archive-btn" data-action="archive" title="Archive this clip (will be deleted)">üóëÔ∏è Archive</button>
                    <button class="action-btn merge-next-btn" data-action="merge_next" {% if not clip.can_merge_next %}disabled title="No valid next clip available for merging"{% else %}title="Mark this clip to be merged with the next sequential clip"{% endif %}>üñáÔ∏è Merge w/ Next</button>

                    {# --- Split Button (conditionally enabled) --- #}
                    <button class="action-btn split-mode-btn"
                            data-action="enter_split_mode"
                            {% if not clip.sprite_metadata or clip.sprite_error %}disabled title="Sprite sheet unavailable or failed, cannot split"{% else %}title="Enter mode to select a frame for splitting"{% endif %} >
                        ‚úÇÔ∏è Split Clip
                    </button>

                     {# --- Retry Sprite Button (only if failed) --- #}
                     {% if clip.sprite_error %}
                     <button class="action-btn retry-sprite-btn" data-action="retry_sprite_gen" title="Attempt to regenerate the sprite sheet">Retry Sprite</button>
                     {% endif %}

                    {# --- Split Controls Panel (hidden by default) --- #}
                    <div class="split-controls" id="split-controls-{{ clip.clip_db_id }}">
                         <span>Use scrub bar or <strong>arrow keys</strong> (‚Üê ‚Üí) when viewer is focused to select split frame. Press Enter to confirm.</span><br>
                         <div class="frame-info">
                             Selected Frame: <span class="split-confirm-frame">0</span> / <span class="split-total-frames">?</span> |
                             Approx. Time: <span class="split-confirm-time">0.00</span>s
                         </div>
                         <button class="action-btn confirm-split-btn" data-action="confirm_split" disabled>Confirm Split at Frame <span class="split-confirm-frame-btn-text">0</span></button>
                         <button class="action-btn cancel-split-btn" data-action="cancel_split_mode" title="Cancel split (Escape key)">Cancel</button>
                         <br><span class="split-feedback"></span> {# Feedback message area #}
                    </div>

                    {# --- Undo Button (conditionally shown by JS) --- #}
                    <button class="undo-button" style="display: none;" title="Undo the last action">Undo</button>
                </div>

                {# --- Action Feedback Area --- #}
                <div class="action-feedback"></div>
            </div>
            {% endfor %}
        {% else %}
            <p>No clips currently pending review.</p>
        {% endif %}
    </div>

    {# --- Load Javascript --- #}
    <script src="{{ url_for('static', path='/sprite-player.js') }}"></script>
    <script src="{{ url_for('static', path='/review-actions.js') }}"></script>
    <script src="{{ url_for('static', path='/review-main.js') }}"></script>
</body>
</html>